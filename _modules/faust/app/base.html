
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>faust.app.base &#8212; Faust 0.2.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="copyright" title="Copyright" href="../../../copyright.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for faust.app.base</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Faust Application.</span>

<span class="sd">An app is an instance of the Faust library.</span>
<span class="sd">Everything starts here.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">tzinfo</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">AsyncIterable</span><span class="p">,</span>
    <span class="n">Awaitable</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">ClassVar</span><span class="p">,</span>
    <span class="n">ContextManager</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">Iterator</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Mapping</span><span class="p">,</span>
    <span class="n">MutableMapping</span><span class="p">,</span>
    <span class="n">MutableSequence</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Pattern</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
    <span class="n">no_type_check</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">opentracing</span>
<span class="kn">from</span> <span class="nn">mode</span> <span class="k">import</span> <span class="n">Seconds</span><span class="p">,</span> <span class="n">Service</span><span class="p">,</span> <span class="n">ServiceT</span><span class="p">,</span> <span class="n">SupervisorStrategyT</span><span class="p">,</span> <span class="n">want_seconds</span>
<span class="kn">from</span> <span class="nn">mode.utils.aiter</span> <span class="k">import</span> <span class="n">aiter</span>
<span class="kn">from</span> <span class="nn">mode.utils.collections</span> <span class="k">import</span> <span class="n">force_mapping</span>
<span class="kn">from</span> <span class="nn">mode.utils.contexts</span> <span class="k">import</span> <span class="n">nullcontext</span>
<span class="kn">from</span> <span class="nn">mode.utils.futures</span> <span class="k">import</span> <span class="n">stampede</span>
<span class="kn">from</span> <span class="nn">mode.utils.imports</span> <span class="k">import</span> <span class="n">import_from_cwd</span><span class="p">,</span> <span class="n">smart_import</span>
<span class="kn">from</span> <span class="nn">mode.utils.logging</span> <span class="k">import</span> <span class="n">flight_recorder</span><span class="p">,</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">mode.utils.objects</span> <span class="k">import</span> <span class="n">cached_property</span><span class="p">,</span> <span class="n">qualname</span><span class="p">,</span> <span class="n">shortlabel</span>
<span class="kn">from</span> <span class="nn">mode.utils.queues</span> <span class="k">import</span> <span class="n">FlowControlEvent</span><span class="p">,</span> <span class="n">ThrowableQueue</span>
<span class="kn">from</span> <span class="nn">mode.utils.types.trees</span> <span class="k">import</span> <span class="n">NodeT</span>
<span class="kn">from</span> <span class="nn">mode.utils.typing</span> <span class="k">import</span> <span class="n">NoReturn</span>

<span class="kn">from</span> <span class="nn">faust</span> <span class="k">import</span> <span class="n">transport</span>
<span class="kn">from</span> <span class="nn">faust.agents</span> <span class="k">import</span> <span class="n">AgentFun</span><span class="p">,</span> <span class="n">AgentManager</span><span class="p">,</span> <span class="n">AgentT</span><span class="p">,</span> <span class="n">ReplyConsumer</span><span class="p">,</span> <span class="n">SinkT</span>
<span class="kn">from</span> <span class="nn">faust.channels</span> <span class="k">import</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">ChannelT</span>
<span class="kn">from</span> <span class="nn">faust.exceptions</span> <span class="k">import</span> <span class="n">ConsumerNotStarted</span><span class="p">,</span> <span class="n">ImproperlyConfigured</span><span class="p">,</span> <span class="n">SameNode</span>
<span class="kn">from</span> <span class="nn">faust.fixups</span> <span class="k">import</span> <span class="n">FixupT</span><span class="p">,</span> <span class="n">fixups</span>
<span class="kn">from</span> <span class="nn">faust.sensors</span> <span class="k">import</span> <span class="n">Monitor</span><span class="p">,</span> <span class="n">SensorDelegate</span>
<span class="kn">from</span> <span class="nn">faust.types._env</span> <span class="k">import</span> <span class="n">STRICT</span>
<span class="kn">from</span> <span class="nn">faust.types.app</span> <span class="k">import</span> <span class="n">AppT</span><span class="p">,</span> <span class="n">BootStrategyT</span><span class="p">,</span> <span class="n">TaskArg</span><span class="p">,</span> <span class="n">TracerT</span>
<span class="kn">from</span> <span class="nn">faust.types.assignor</span> <span class="k">import</span> <span class="n">LeaderAssignorT</span><span class="p">,</span> <span class="n">PartitionAssignorT</span>
<span class="kn">from</span> <span class="nn">faust.types.codecs</span> <span class="k">import</span> <span class="n">CodecArg</span>
<span class="kn">from</span> <span class="nn">faust.types.core</span> <span class="k">import</span> <span class="n">HeadersArg</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">V</span>
<span class="kn">from</span> <span class="nn">faust.types.enums</span> <span class="k">import</span> <span class="n">ProcessingGuarantee</span>
<span class="kn">from</span> <span class="nn">faust.types.events</span> <span class="k">import</span> <span class="n">EventT</span>
<span class="kn">from</span> <span class="nn">faust.types.models</span> <span class="k">import</span> <span class="n">ModelArg</span>
<span class="kn">from</span> <span class="nn">faust.types.router</span> <span class="k">import</span> <span class="n">RouterT</span>
<span class="kn">from</span> <span class="nn">faust.types.serializers</span> <span class="k">import</span> <span class="n">RegistryT</span><span class="p">,</span> <span class="n">SchemaT</span>
<span class="kn">from</span> <span class="nn">faust.types.settings</span> <span class="k">import</span> <span class="n">Settings</span> <span class="k">as</span> <span class="n">_Settings</span>
<span class="kn">from</span> <span class="nn">faust.types.streams</span> <span class="k">import</span> <span class="n">StreamT</span>
<span class="kn">from</span> <span class="nn">faust.types.tables</span> <span class="k">import</span> <span class="n">CollectionT</span><span class="p">,</span> <span class="n">GlobalTableT</span><span class="p">,</span> <span class="n">TableManagerT</span><span class="p">,</span> <span class="n">TableT</span>
<span class="kn">from</span> <span class="nn">faust.types.topics</span> <span class="k">import</span> <span class="n">TopicT</span>
<span class="kn">from</span> <span class="nn">faust.types.transports</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ConductorT</span><span class="p">,</span>
    <span class="n">ConsumerT</span><span class="p">,</span>
    <span class="n">ProducerT</span><span class="p">,</span>
    <span class="n">TPorTopicSet</span><span class="p">,</span>
    <span class="n">TransportT</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">faust.types.tuples</span> <span class="k">import</span> <span class="n">TP</span><span class="p">,</span> <span class="n">Message</span><span class="p">,</span> <span class="n">MessageSentCallback</span><span class="p">,</span> <span class="n">RecordMetadata</span>
<span class="kn">from</span> <span class="nn">faust.types.web</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">CacheBackendT</span><span class="p">,</span>
    <span class="n">HttpClientT</span><span class="p">,</span>
    <span class="n">PageArg</span><span class="p">,</span>
    <span class="n">Request</span><span class="p">,</span>
    <span class="n">ResourceOptions</span><span class="p">,</span>
    <span class="n">Response</span><span class="p">,</span>
    <span class="n">ViewDecorator</span><span class="p">,</span>
    <span class="n">ViewHandlerFun</span><span class="p">,</span>
    <span class="n">Web</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">faust.types.windows</span> <span class="k">import</span> <span class="n">WindowT</span>
<span class="kn">from</span> <span class="nn">faust.utils</span> <span class="k">import</span> <span class="n">cron</span><span class="p">,</span> <span class="n">venusian</span>
<span class="kn">from</span> <span class="nn">faust.utils.tracing</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">call_with_trace</span><span class="p">,</span>
    <span class="n">noop_span</span><span class="p">,</span>
    <span class="n">operation_name_from_fun</span><span class="p">,</span>
    <span class="n">set_current_span</span><span class="p">,</span>
    <span class="n">traced_from_parent_span</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">faust.web</span> <span class="k">import</span> <span class="n">drivers</span> <span class="k">as</span> <span class="n">web_drivers</span>
<span class="kn">from</span> <span class="nn">faust.web.cache</span> <span class="k">import</span> <span class="n">backends</span> <span class="k">as</span> <span class="n">cache_backends</span>
<span class="kn">from</span> <span class="nn">faust.web.views</span> <span class="k">import</span> <span class="n">View</span>

<span class="kn">from</span> <span class="nn">._attached</span> <span class="k">import</span> <span class="n">Attachments</span>

<span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="kn">from</span> <span class="nn">faust.cli.base</span> <span class="k">import</span> <span class="n">AppCommand</span> <span class="k">as</span> <span class="n">_AppCommand</span>
    <span class="kn">from</span> <span class="nn">faust.livecheck</span> <span class="k">import</span> <span class="n">LiveCheck</span> <span class="k">as</span> <span class="n">_LiveCheck</span>
    <span class="kn">from</span> <span class="nn">faust.transport.consumer</span> <span class="k">import</span> <span class="n">Fetcher</span> <span class="k">as</span> <span class="n">_Fetcher</span>
    <span class="kn">from</span> <span class="nn">faust.worker</span> <span class="k">import</span> <span class="n">Worker</span> <span class="k">as</span> <span class="n">_Worker</span>
<span class="k">else</span><span class="p">:</span>

    <span class="k">class</span> <span class="nc">_AppCommand</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># noqa</span>

    <span class="k">class</span> <span class="nc">_LiveCheck</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># noqa</span>

    <span class="k">class</span> <span class="nc">_Fetcher</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># noqa</span>

    <span class="k">class</span> <span class="nc">_Worker</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># noqa</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;App&quot;</span><span class="p">,</span> <span class="s2">&quot;BootStrategy&quot;</span><span class="p">]</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">)</span>

<span class="c1">#: Format string for ``repr(app)``.</span>
<span class="n">APP_REPR_FINALIZED</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;</span><span class="si">{name}</span><span class="s2">(</span><span class="si">{c.id}</span><span class="s2">): </span><span class="si">{c.broker}</span><span class="s2"> </span><span class="si">{s.state}</span><span class="s2"> agents(</span><span class="si">{agents}</span><span class="s2">) </span><span class="si">{id:#x}</span><span class="s2">&gt;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="n">APP_REPR_UNFINALIZED</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;</span><span class="si">{name}</span><span class="s2">: &lt;non-finalized&gt; </span><span class="si">{id:#x}</span><span class="s2">&gt;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="c1"># Venusian (pypi): This is used for &quot;autodiscovery&quot; of user code,</span>
<span class="c1"># CLI commands, and much more.</span>
<span class="c1"># Named after same concept from Django: the Django Admin autodiscover function</span>
<span class="c1"># that finds custom admin configuration in ``{app}/admin.py`` modules.</span>

<span class="n">SCAN_AGENT</span> <span class="o">=</span> <span class="s2">&quot;faust.agent&quot;</span>
<span class="n">SCAN_COMMAND</span> <span class="o">=</span> <span class="s2">&quot;faust.command&quot;</span>
<span class="n">SCAN_PAGE</span> <span class="o">=</span> <span class="s2">&quot;faust.page&quot;</span>
<span class="n">SCAN_SERVICE</span> <span class="o">=</span> <span class="s2">&quot;faust.service&quot;</span>
<span class="n">SCAN_TASK</span> <span class="o">=</span> <span class="s2">&quot;faust.task&quot;</span>

<span class="c1">#: Default decorator categories for :pypi`venusian` to scan for when</span>
<span class="c1">#: autodiscovering things like @app.agent decorators.</span>
<span class="n">SCAN_CATEGORIES</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">SCAN_AGENT</span><span class="p">,</span>
    <span class="n">SCAN_COMMAND</span><span class="p">,</span>
    <span class="n">SCAN_PAGE</span><span class="p">,</span>
    <span class="n">SCAN_SERVICE</span><span class="p">,</span>
    <span class="n">SCAN_TASK</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1">#: List of regular expressions for :pypi:`venusian` that acts as a filter</span>
<span class="c1">#: for modules that :pypi:`venusian` should ignore when autodiscovering</span>
<span class="c1">#: decorators.</span>
<span class="n">SCAN_IGNORE</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;test_.*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">,</span>
    <span class="s2">&quot;.__main__&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">E_NEED_ORIGIN</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">`origin` argument to faust.App is mandatory when autodiscovery enabled.</span>

<span class="s2">This parameter sets the canonical path to the project package,</span>
<span class="s2">and describes how a user, or program can find it on the command-line when using</span>
<span class="s2">the `faust -A project` option.  It&#39;s also used as the default package</span>
<span class="s2">to scan when autodiscovery is enabled.</span>

<span class="s2">If your app is defined in a module: ``project/app.py``, then the</span>
<span class="s2">origin will be &quot;project&quot;:</span>

<span class="s2">    # file: project/app.py</span>
<span class="s2">    import faust</span>

<span class="s2">    app = faust.App(</span>
<span class="s2">        id=&#39;myid&#39;,</span>
<span class="s2">        origin=&#39;project&#39;,</span>
<span class="s2">    )</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">W_OPTION_DEPRECATED</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Argument </span><span class="si">{old!r}</span><span class="s2"> is deprecated and scheduled for removal in Faust 1.0.</span>

<span class="s2">Please use </span><span class="si">{new!r}</span><span class="s2"> instead.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">W_DEPRECATED_SHARD_PARAM</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">The second argument to `@table_route` is deprecated,</span>
<span class="s2">please use the `query_param` keyword argument instead.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># @app.task decorator may be called in several ways:</span>
<span class="c1">#</span>
<span class="c1"># 1) Without parens:</span>
<span class="c1">#    @app.task</span>
<span class="c1">#    async def foo():</span>
<span class="c1">#</span>
<span class="c1"># 2) With parens:</span>
<span class="c1">#   @app.task()</span>
<span class="c1">#</span>
<span class="c1"># 3) With parens and arguments</span>
<span class="c1">#   @app.task(on_leader=True)</span>
<span class="c1">#</span>
<span class="c1"># This means @app.task attempts to do the right thing depending</span>
<span class="c1"># on how it&#39;s used. All the frameworks do this, but we have to also type it.</span>
<span class="n">TaskDecoratorRet</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span>
    <span class="n">Callable</span><span class="p">[[</span><span class="n">TaskArg</span><span class="p">],</span> <span class="n">TaskArg</span><span class="p">],</span>
    <span class="n">TaskArg</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="BootStrategy"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.BootStrategy">[docs]</a><span class="k">class</span> <span class="nc">BootStrategy</span><span class="p">(</span><span class="n">BootStrategyT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;App startup strategy.</span>

<span class="sd">    The startup strategy defines the graph of services</span>
<span class="sd">    to start when the Faust worker for an app starts.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">enable_kafka</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># We want these to take default from `enable_kafka`</span>
    <span class="c1"># attribute, but still want to allow subclasses to define</span>
    <span class="c1"># them like this:</span>
    <span class="c1">#   class MyBoot(BootStrategy):</span>
    <span class="c1">#       enable_kafka_consumer = False</span>
    <span class="n">enable_kafka_consumer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">enable_kafka_producer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">enable_web</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">enable_sensors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">AppT</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">enable_web</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">enable_kafka</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">enable_kafka_producer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">enable_kafka_consumer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">enable_sensors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

        <span class="k">if</span> <span class="n">enable_kafka</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enable_kafka</span> <span class="o">=</span> <span class="n">enable_kafka</span>
        <span class="k">if</span> <span class="n">enable_kafka_producer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enable_kafka_producer</span> <span class="o">=</span> <span class="n">enable_kafka_producer</span>
        <span class="k">if</span> <span class="n">enable_kafka_consumer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enable_kafka_consumer</span> <span class="o">=</span> <span class="n">enable_kafka_consumer</span>
        <span class="k">if</span> <span class="n">enable_web</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enable_web</span> <span class="o">=</span> <span class="n">enable_web</span>
        <span class="k">if</span> <span class="n">enable_sensors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enable_sensors</span> <span class="o">=</span> <span class="n">enable_sensors</span>

<div class="viewcode-block" id="BootStrategy.server"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.BootStrategy.server">[docs]</a>    <span class="k">def</span> <span class="nf">server</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return services to start when app is in default mode.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chain</span><span class="p">(</span>
            <span class="c1"># Sensors (Sensor): always start first and stop last.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sensors</span><span class="p">(),</span>
            <span class="c1"># Producer: always stop after Consumer.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kafka_producer</span><span class="p">(),</span>
            <span class="c1"># Web</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">web_server</span><span class="p">(),</span>
            <span class="c1"># Consumer: always stop after Conductor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kafka_consumer</span><span class="p">(),</span>
            <span class="c1"># AgentManager starts agents (app.agents)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">(),</span>
            <span class="c1"># Conductor (transport.Conductor))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kafka_conductor</span><span class="p">(),</span>
            <span class="c1"># Table Manager (app.TableManager)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">(),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="BootStrategy.client_only"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.BootStrategy.client_only">[docs]</a>    <span class="k">def</span> <span class="nf">client_only</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return services to start when app is in client_only mode.&quot;&quot;&quot;</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">App</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chain</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kafka_producer</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kafka_client_consumer</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kafka_conductor</span><span class="p">(),</span>
            <span class="p">[</span><span class="n">app</span><span class="o">.</span><span class="n">_fetcher</span><span class="p">],</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="BootStrategy.producer_only"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.BootStrategy.producer_only">[docs]</a>    <span class="k">def</span> <span class="nf">producer_only</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return services to start when app is in producer_only mode.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chain</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">web_server</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kafka_producer</span><span class="p">(),</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">arguments</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Iterable</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">],</span> <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">arguments</span><span class="p">))</span>

<div class="viewcode-block" id="BootStrategy.sensors"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.BootStrategy.sensors">[docs]</a>    <span class="k">def</span> <span class="nf">sensors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return list of services required to start sensors.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_sensors</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">sensors</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="BootStrategy.kafka_producer"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.BootStrategy.kafka_producer">[docs]</a>    <span class="k">def</span> <span class="nf">kafka_producer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return list of services required to start Kafka producer.&quot;&quot;&quot;</span>
        <span class="n">producers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_enable_kafka_producer</span><span class="p">():</span>
            <span class="n">producers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">producer</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">producer_threaded</span><span class="p">:</span>
                <span class="n">producers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">producer</span><span class="o">.</span><span class="n">threaded_producer</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">producers</span></div>

    <span class="k">def</span> <span class="nf">_should_enable_kafka_producer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_kafka_producer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_kafka</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_kafka_producer</span>

<div class="viewcode-block" id="BootStrategy.kafka_consumer"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.BootStrategy.kafka_consumer">[docs]</a>    <span class="k">def</span> <span class="nf">kafka_consumer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return list of services required to start Kafka consumer.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_enable_kafka_consumer</span><span class="p">():</span>
            <span class="n">app</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">App</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">consumer</span><span class="p">,</span>
                <span class="c1"># Leader Assignor (assignor.LeaderAssignor)</span>
                <span class="n">app</span><span class="o">.</span><span class="n">_leader_assignor</span><span class="p">,</span>
                <span class="c1"># Reply Consumer (ReplyConsumer)</span>
                <span class="n">app</span><span class="o">.</span><span class="n">_reply_consumer</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="p">[]</span></div>

    <span class="k">def</span> <span class="nf">_should_enable_kafka_consumer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_kafka_consumer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_kafka</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_kafka_consumer</span>

<div class="viewcode-block" id="BootStrategy.kafka_client_consumer"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.BootStrategy.kafka_client_consumer">[docs]</a>    <span class="k">def</span> <span class="nf">kafka_client_consumer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return list of services required to start Kafka client consumer.&quot;&quot;&quot;</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">App</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">app</span><span class="o">.</span><span class="n">consumer</span><span class="p">,</span>
            <span class="n">app</span><span class="o">.</span><span class="n">_reply_consumer</span><span class="p">,</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="BootStrategy.agents"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.BootStrategy.agents">[docs]</a>    <span class="k">def</span> <span class="nf">agents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return list of services required to start agents.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">agents</span><span class="p">]</span></div>

<div class="viewcode-block" id="BootStrategy.kafka_conductor"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.BootStrategy.kafka_conductor">[docs]</a>    <span class="k">def</span> <span class="nf">kafka_conductor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return list of services required to start Kafka conductor.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_enable_kafka_consumer</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">topics</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="BootStrategy.web_server"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.BootStrategy.web_server">[docs]</a>    <span class="k">def</span> <span class="nf">web_server</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return list of web-server services.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_enable_web</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">web_components</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">web</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[]</span></div>

    <span class="k">def</span> <span class="nf">_should_enable_web</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_web</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">web_enabled</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_web</span>

<div class="viewcode-block" id="BootStrategy.web_components"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.BootStrategy.web_components">[docs]</a>    <span class="k">def</span> <span class="nf">web_components</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return list of web-related services (excluding web server).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">cache</span><span class="p">]</span></div>

<div class="viewcode-block" id="BootStrategy.tables"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.BootStrategy.tables">[docs]</a>    <span class="k">def</span> <span class="nf">tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return list of table-related services.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_enable_kafka_consumer</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">tables</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[]</span></div></div>


<div class="viewcode-block" id="App"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App">[docs]</a><span class="k">class</span> <span class="nc">App</span><span class="p">(</span><span class="n">AppT</span><span class="p">,</span> <span class="n">Service</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Faust Application.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        id (str): Application ID.</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">        loop (asyncio.AbstractEventLoop): optional event loop to use.</span>

<span class="sd">    See Also:</span>
<span class="sd">        :ref:`application-configuration` -- for supported keyword arguments.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SCAN_CATEGORIES</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">SCAN_CATEGORIES</span><span class="p">)</span>

    <span class="n">BootStrategy</span> <span class="o">=</span> <span class="n">BootStrategy</span>
    <span class="n">Settings</span> <span class="o">=</span> <span class="n">_Settings</span>

    <span class="c1">#: Set this to True if app should only start the services required to</span>
    <span class="c1">#: operate as an RPC client (producer and simple reply consumer).</span>
    <span class="n">client_only</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#: Set this to True if app should run without consumer/tables.</span>
    <span class="n">producer_only</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#: Source of configuration: ``app.conf`` (when configured)</span>
    <span class="n">_conf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_Settings</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Original configuration source object.</span>
    <span class="n">_config_source</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Default consumer instance.</span>
    <span class="n">_consumer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ConsumerT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Default producer instance.</span>
    <span class="n">_producer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProducerT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Consumer transport is created on demand:</span>
    <span class="c1"># use `.transport` property.</span>
    <span class="n">_transport</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TransportT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Producer transport is created on demand:</span>
    <span class="c1"># use `.producer_transport` property.</span>
    <span class="n">_producer_transport</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TransportT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Cache is created on demand: use `.cache` property.</span>
    <span class="n">_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CacheBackendT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Monitor is created on demand: use `.monitor` property.</span>
    <span class="n">_monitor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Monitor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @app.task decorator adds asyncio tasks to be started</span>
    <span class="c1"># with the app here.</span>
    <span class="n">_app_tasks</span><span class="p">:</span> <span class="n">MutableSequence</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="n">Awaitable</span><span class="p">]]</span>

    <span class="n">_http_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HttpClientT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_extra_services</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]]</span>
    <span class="n">_extra_service_instances</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># See faust/app/_attached.py</span>
    <span class="n">_attachments</span><span class="p">:</span> <span class="n">Attachments</span>

    <span class="c1">#: Current assignment</span>
    <span class="n">_assignment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="n">TP</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Optional tracing support.</span>
    <span class="n">tracer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TracerT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_rebalancing_span</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">opentracing</span><span class="o">.</span><span class="n">Span</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_rebalancing_sensor_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">monitor</span><span class="p">:</span> <span class="n">Monitor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config_source</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">loop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">beacon</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NodeT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">options</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This is passed to the configuration in self.conf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_options</span> <span class="o">=</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="c1"># The agent manager manages all agents.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agents</span> <span class="o">=</span> <span class="n">AgentManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Sensors monitor Faust using a standard sensor API.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sensors</span> <span class="o">=</span> <span class="n">SensorDelegate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># this is a local hack we use until we have proper</span>
        <span class="c1"># transactions support in the Python Kafka Client</span>
        <span class="c1"># and can have &quot;exactly once&quot; semantics.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attachments</span> <span class="o">=</span> <span class="n">Attachments</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># &quot;The Monitor&quot; is a special sensor that provides detailed stats</span>
        <span class="c1"># for the web server.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span> <span class="o">=</span> <span class="n">monitor</span>

        <span class="c1"># Any additional asyncio.Task&#39;s specified using @app.task decorator.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app_tasks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Called as soon as the a worker is fully operational.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_startup_finished</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Any additional services added using the @app.service decorator.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_services</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># The configuration source object/module passed to ``config_by_object``</span>
        <span class="c1"># for introspectio purposes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_source</span> <span class="o">=</span> <span class="n">config_source</span>

        <span class="c1"># create default sender for signals such as self.on_configured</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_signals</span><span class="p">()</span>

        <span class="c1"># initialize fixups (automatically applied extensions,</span>
        <span class="c1"># such as Django integration).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_fixups</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">boot_strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BootStrategy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">,</span> <span class="n">beacon</span><span class="o">=</span><span class="n">beacon</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Signals in Faust are the same as in Django, but asynchronous by</span>
        <span class="c1"># default (:class:`mode.SyncSignal` is the normal ``def`` version)).</span>
        <span class="c1">#</span>
        <span class="c1"># Signals in Faust are usually local to the app instance::</span>
        <span class="c1">#</span>
        <span class="c1">#  @app.on_before_configured.connect  # &lt;-- only sent by this app</span>
        <span class="c1">#  def on_before_configured(self):</span>
        <span class="c1">#    ...</span>
        <span class="c1">#</span>
        <span class="c1"># In Django signals are usually global, and an easter-egg</span>
        <span class="c1"># provides this in Faust also::</span>
        <span class="c1">#</span>
        <span class="c1">#    V---- NOTE upper case A in App</span>
        <span class="c1">#   @App.on_before_configured.connect  # &lt;-- sent by ALL apps</span>
        <span class="c1">#   def on_before_configured(app):</span>
        <span class="c1">#</span>
        <span class="c1"># Note: Signals are local-only, and cannot do anything to other</span>
        <span class="c1"># processes or machines.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_before_configured</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_before_configured</span><span class="o">.</span><span class="n">with_default_sender</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_configured</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_configured</span><span class="o">.</span><span class="n">with_default_sender</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_after_configured</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_after_configured</span><span class="o">.</span><span class="n">with_default_sender</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_partitions_assigned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_partitions_assigned</span><span class="o">.</span><span class="n">with_default_sender</span><span class="p">(</span>
            <span class="bp">self</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_partitions_revoked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_partitions_revoked</span><span class="o">.</span><span class="n">with_default_sender</span><span class="p">(</span>
            <span class="bp">self</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_worker_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_worker_init</span><span class="o">.</span><span class="n">with_default_sender</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_rebalance_complete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_rebalance_complete</span><span class="o">.</span><span class="n">with_default_sender</span><span class="p">(</span>
            <span class="bp">self</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_before_shutdown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_before_shutdown</span><span class="o">.</span><span class="n">with_default_sender</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_produce_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_produce_message</span><span class="o">.</span><span class="n">with_default_sender</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_fixups</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MutableSequence</span><span class="p">[</span><span class="n">FixupT</span><span class="p">]:</span>
        <span class="c1"># Returns list of &quot;fixups&quot;</span>
        <span class="c1"># Fixups are small additional patches we apply when certain</span>
        <span class="c1"># platforms or frameworks are present.</span>
        <span class="c1">#</span>
        <span class="c1"># One example is the Django fixup, responsible for Django integration</span>
        <span class="c1"># whenever the DJANGO_SETTINGS_MODULE environment variable is</span>
        <span class="c1"># set. See faust/fixups/django.py, it&#39;s not complicated - using</span>
        <span class="c1"># setuptools entry points you can very easily create extensions that</span>
        <span class="c1"># are automatically enabled by installing a PyPI package with</span>
        <span class="c1"># `pip install myname`.</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixups</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

<div class="viewcode-block" id="App.on_init_dependencies"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.on_init_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">on_init_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return list of additional service dependencies.</span>

<span class="sd">        The services returned will be started with the</span>
<span class="sd">        app when the app starts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Add the main Monitor sensor.</span>
        <span class="c1"># The beacon is also reattached in case the monitor</span>
        <span class="c1"># was created by the user.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">beacon</span><span class="o">.</span><span class="n">reattach</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beacon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sensors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">producer_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">boot_strategy</span><span class="o">.</span><span class="n">producer_only</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">boot_strategy</span><span class="o">.</span><span class="n">client_only</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">boot_strategy</span><span class="o">.</span><span class="n">server</span><span class="p">()</span></div>

<div class="viewcode-block" id="App.on_first_start"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.on_first_start">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_first_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Call first time app starts in this process.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_directories</span><span class="p">()</span></div>

<div class="viewcode-block" id="App.on_start"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.on_start">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Call every time app start/restarts.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

        <span class="c1"># This makes it so that the topic conductor is a child</span>
        <span class="c1"># of consumer in the (pretty) dependency graph.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topics</span><span class="o">.</span><span class="n">beacon</span><span class="o">.</span><span class="n">reattach</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">beacon</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;!!! DEBUG is enabled -- disable for production environments&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="App.on_started"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.on_started">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_started</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Call when app is fully started.&quot;&quot;&quot;</span>
        <span class="c1"># Wait for table recovery to complete (returns True if app stopped)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_table_recovery_completed</span><span class="p">():</span>
            <span class="c1"># Add all asyncio.Tasks, like timers, etc.</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_started_init_extra_tasks</span><span class="p">()</span>

            <span class="c1"># Start user-provided services.</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_started_init_extra_services</span><span class="p">()</span>

            <span class="c1"># Call the app-is-fully-started callback used by Worker</span>
            <span class="c1"># to print the &quot;ready&quot; message that signals to the user that</span>
            <span class="c1"># the worker is ready to start processing.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_startup_finished</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_startup_finished</span><span class="p">()</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_wait_for_table_recovery_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">wait_until_recovery_completed</span><span class="p">()</span>

<div class="viewcode-block" id="App.on_started_init_extra_tasks"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.on_started_init_extra_tasks">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_started_init_extra_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Call when started to start additional tasks.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_tasks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_future</span><span class="p">(</span><span class="n">task</span><span class="p">())</span></div>

<div class="viewcode-block" id="App.on_started_init_extra_services"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.on_started_init_extra_services">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_started_init_extra_services</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Call when initializing extra services at startup.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_service_instances</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># instantiate the services added using the @app.service decorator.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extra_service_instances</span> <span class="o">=</span> <span class="p">[</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_init_extra_service</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_services</span>
            <span class="p">]</span></div>

<div class="viewcode-block" id="App.on_init_extra_service"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.on_init_extra_service">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_init_extra_service</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ServiceT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Call when adding user services to this app.&quot;&quot;&quot;</span>
        <span class="n">s</span><span class="p">:</span> <span class="n">ServiceT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_subservice</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
        <span class="c1"># start the service now, or when the app is started.</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_runtime_dependency</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span></div>

    <span class="k">def</span> <span class="nf">_prepare_subservice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">ServiceT</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">service</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Type</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">],</span> <span class="n">service</span><span class="p">)(</span>
                <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">,</span>
                <span class="n">beacon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beacon</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">ServiceT</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span>

<div class="viewcode-block" id="App.config_from_object"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.config_from_object">[docs]</a>    <span class="k">def</span> <span class="nf">config_from_object</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read configuration from object.</span>

<span class="sd">        Object is either an actual object or the name of a module to import.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; app.config_from_object(&#39;myproj.faustconfig&#39;)</span>

<span class="sd">            &gt;&gt;&gt; from myproj import faustconfig</span>
<span class="sd">            &gt;&gt;&gt; app.config_from_object(faustconfig)</span>

<span class="sd">        Arguments:</span>
<span class="sd">            silent (bool): If true then import errors will be ignored.</span>
<span class="sd">            force (bool): Force reading configuration immediately.</span>
<span class="sd">                By default the configuration will be read only when required.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_source</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalized</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">configured</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Settings</span><span class="o">.</span><span class="n">_warn_already_configured</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">force</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">configured</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span></div>

<div class="viewcode-block" id="App.finalize"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Finalize app configuration.&quot;&quot;&quot;</span>
        <span class="c1"># Finalization signals that the application have been configured</span>
        <span class="c1"># and is ready to use.</span>

        <span class="c1"># If you access configuration before an explicit call to</span>
        <span class="c1"># ``app.finalize()`` you will get an error.</span>
        <span class="c1"># The ``app.main`` entry point and the ``faust -A app`` command</span>
        <span class="c1"># both will automatically finalize the app for you.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finalized</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s2">&quot;App requires an id!&quot;</span><span class="p">)</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_maybe_close_http_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http_client</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="App.worker_init"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.worker_init">[docs]</a>    <span class="k">def</span> <span class="nf">worker_init</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Init worker/CLI commands.&quot;&quot;&quot;</span>
        <span class="c1"># This init is called by the `faust worker` command.</span>
        <span class="k">for</span> <span class="n">fixup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixups</span><span class="p">:</span>
            <span class="n">fixup</span><span class="o">.</span><span class="n">on_worker_init</span><span class="p">()</span></div>

<div class="viewcode-block" id="App.worker_init_post_autodiscover"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.worker_init_post_autodiscover">[docs]</a>    <span class="k">def</span> <span class="nf">worker_init_post_autodiscover</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Init worker after autodiscover.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">init_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_worker_init</span><span class="o">.</span><span class="n">send</span><span class="p">()</span></div>

<div class="viewcode-block" id="App.discover"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.discover">[docs]</a>    <span class="k">def</span> <span class="nf">discover</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">extra_modules</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">categories</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ignore</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCAN_IGNORE</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Discover decorators in packages.&quot;&quot;&quot;</span>
        <span class="c1"># based on autodiscovery in Django,</span>
        <span class="c1"># but finds @app.agent decorators, and so on.</span>
        <span class="k">if</span> <span class="n">categories</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">categories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SCAN_CATEGORIES</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_discovery_modules</span><span class="p">())</span>
        <span class="n">modules</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">extra_modules</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fixup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixups</span><span class="p">:</span>
            <span class="n">modules</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fixup</span><span class="o">.</span><span class="n">autodiscover_modules</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">modules</span><span class="p">:</span>
            <span class="n">scanner</span> <span class="o">=</span> <span class="n">venusian</span><span class="o">.</span><span class="n">Scanner</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">ModuleNotFoundError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ModuleNotFoundError</span><span class="p">(</span>
                        <span class="n">f</span><span class="s2">&quot;Unknown module </span><span class="si">{name}</span><span class="s2"> in App.conf.autodiscover list&quot;</span>
                    <span class="p">)</span>
                <span class="n">scanner</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
                    <span class="n">module</span><span class="p">,</span>
                    <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">,</span>
                    <span class="n">categories</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">categories</span><span class="p">),</span>
                    <span class="n">onerror</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_autodiscovery_error</span><span class="p">,</span>
                <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_on_autodiscovery_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Autodiscovery importing module </span><span class="si">%r</span><span class="s2"> raised error: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_discovery_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">modules</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">autodiscover</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">autodiscover</span>
        <span class="k">if</span> <span class="n">autodiscover</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">autodiscover</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">origin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="n">E_NEED_ORIGIN</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">autodiscover</span><span class="p">):</span>
                <span class="n">modules</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">Callable</span><span class="p">[[],</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">autodiscover</span><span class="p">)())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">modules</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">autodiscover</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">origin</span><span class="p">:</span>
                <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">modules</span>

<div class="viewcode-block" id="App.main"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.main">[docs]</a>    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Execute the :program:`faust` umbrella command using this app.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">faust.cli.faust</span> <span class="k">import</span> <span class="n">cli</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_init</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">autodiscover</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discover</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_init_post_autodiscover</span><span class="p">()</span>
        <span class="n">cli</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">3451</span><span class="p">)</span>  <span class="c1"># for mypy: NoReturn</span></div>

<div class="viewcode-block" id="App.topic"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.topic">[docs]</a>    <span class="k">def</span> <span class="nf">topic</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">topics</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">pattern</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Pattern</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SchemaT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">key_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ModelArg</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">value_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ModelArg</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">key_serializer</span><span class="p">:</span> <span class="n">CodecArg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">value_serializer</span><span class="p">:</span> <span class="n">CodecArg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">partitions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">retention</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Seconds</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">compacting</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">deleting</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">replicas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">acks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">internal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">maxsize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">allow_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">has_prefix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">loop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TopicT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create topic description.</span>

<span class="sd">        Topics are named channels (for example a Kafka topic),</span>
<span class="sd">        that exist on a server.  To make an ephemeral local communication</span>
<span class="sd">        channel use: :meth:`channel`.</span>

<span class="sd">        See Also:</span>
<span class="sd">            :class:`faust.topics.Topic`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span>
            <span class="n">TopicT</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">Topic</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">topics</span><span class="o">=</span><span class="n">topics</span><span class="p">,</span>
                <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
                <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
                <span class="n">key_type</span><span class="o">=</span><span class="n">key_type</span><span class="p">,</span>
                <span class="n">value_type</span><span class="o">=</span><span class="n">value_type</span><span class="p">,</span>
                <span class="n">key_serializer</span><span class="o">=</span><span class="n">key_serializer</span><span class="p">,</span>
                <span class="n">value_serializer</span><span class="o">=</span><span class="n">value_serializer</span><span class="p">,</span>
                <span class="n">partitions</span><span class="o">=</span><span class="n">partitions</span><span class="p">,</span>
                <span class="n">retention</span><span class="o">=</span><span class="n">retention</span><span class="p">,</span>
                <span class="n">compacting</span><span class="o">=</span><span class="n">compacting</span><span class="p">,</span>
                <span class="n">deleting</span><span class="o">=</span><span class="n">deleting</span><span class="p">,</span>
                <span class="n">replicas</span><span class="o">=</span><span class="n">replicas</span><span class="p">,</span>
                <span class="n">acks</span><span class="o">=</span><span class="n">acks</span><span class="p">,</span>
                <span class="n">internal</span><span class="o">=</span><span class="n">internal</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="n">allow_empty</span><span class="o">=</span><span class="n">allow_empty</span><span class="p">,</span>
                <span class="n">has_prefix</span><span class="o">=</span><span class="n">has_prefix</span><span class="p">,</span>
                <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="App.channel"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.channel">[docs]</a>    <span class="k">def</span> <span class="nf">channel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SchemaT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">key_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ModelArg</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">value_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ModelArg</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">maxsize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">loop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChannelT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create new channel.</span>

<span class="sd">        By default this will create an in-memory channel</span>
<span class="sd">        used for intra-process communication, but in practice</span>
<span class="sd">        channels can be backed by any transport (network or even means</span>
<span class="sd">        of inter-process communication).</span>

<span class="sd">        See Also:</span>
<span class="sd">            :class:`faust.channels.Channel`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Channel</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">key_type</span><span class="o">=</span><span class="n">key_type</span><span class="p">,</span>
            <span class="n">value_type</span><span class="o">=</span><span class="n">value_type</span><span class="p">,</span>
            <span class="n">maxsize</span><span class="o">=</span><span class="n">maxsize</span><span class="p">,</span>
            <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="App.agent"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.agent">[docs]</a>    <span class="k">def</span> <span class="nf">agent</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">channel</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ChannelT</span><span class="p">[</span><span class="n">_T</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">supervisor_strategy</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">SupervisorStrategyT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sink</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">SinkT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">isolated_partitions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">use_reply_headers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">AgentFun</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span> <span class="n">AgentT</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Create Agent from async def function.</span>

<span class="sd">        It can be a regular async function::</span>

<span class="sd">            @app.agent()</span>
<span class="sd">            async def my_agent(stream):</span>
<span class="sd">                async for number in stream:</span>
<span class="sd">                    print(f&#39;Received: {number!r}&#39;)</span>

<span class="sd">        Or it can be an async iterator that yields values.</span>
<span class="sd">        These values can be used as the reply in an RPC-style call,</span>
<span class="sd">        or for sinks: callbacks that forward events to</span>
<span class="sd">        other agents/topics/statsd, and so on::</span>

<span class="sd">            @app.agent(sink=[log_topic])</span>
<span class="sd">            async def my_agent(requests):</span>
<span class="sd">                async for number in requests:</span>
<span class="sd">                    yield number * 2</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">fun</span><span class="p">:</span> <span class="n">AgentFun</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">AgentT</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
            <span class="n">agent</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
                <span class="n">AgentT</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                    <span class="n">fun</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
                    <span class="n">concurrency</span><span class="o">=</span><span class="n">concurrency</span><span class="p">,</span>
                    <span class="n">supervisor_strategy</span><span class="o">=</span><span class="n">supervisor_strategy</span><span class="p">,</span>
                    <span class="n">sink</span><span class="o">=</span><span class="n">sink</span><span class="p">,</span>
                    <span class="n">isolated_partitions</span><span class="o">=</span><span class="n">isolated_partitions</span><span class="p">,</span>
                    <span class="n">on_error</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_agent_error</span><span class="p">,</span>
                    <span class="n">use_reply_headers</span><span class="o">=</span><span class="n">use_reply_headers</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="n">fun</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span>
            <span class="c1"># This connects the agent to the topic conductor</span>
            <span class="c1"># to make the graph more pretty.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topics</span><span class="o">.</span><span class="n">beacon</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
            <span class="n">venusian</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">SCAN_AGENT</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">agent</span>

        <span class="k">return</span> <span class="n">_inner</span></div>

    <span class="n">actor</span> <span class="o">=</span> <span class="n">agent</span>  <span class="c1"># XXX Compatibility alias: REMOVE FOR 1.0</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_on_agent_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">AgentT</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># See agent-errors in docs/userguide/agents.rst</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consumer</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consumer</span><span class="o">.</span><span class="n">on_task_error</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">MemoryError</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Consumer error callback raised: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>

<div class="viewcode-block" id="App.task"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.task">[docs]</a>    <span class="nd">@no_type_check</span>
    <span class="k">def</span> <span class="nf">task</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">fun</span><span class="p">:</span> <span class="n">TaskArg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">on_leader</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">traced</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskDecoratorRet</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Define an async def function to be started with the app.</span>

<span class="sd">        This is like :meth:`timer` but a one-shot task only</span>
<span class="sd">        executed at worker startup (after recovery and the worker is</span>
<span class="sd">        fully ready for operation).</span>

<span class="sd">        The function may take zero, or one argument.</span>
<span class="sd">        If the target function takes an argument, the ``app`` argument</span>
<span class="sd">        is passed::</span>

<span class="sd">            &gt;&gt;&gt; @app.task</span>
<span class="sd">            &gt;&gt;&gt; async def on_startup(app):</span>
<span class="sd">            ...    print(&#39;STARTING UP: %r&#39; % (app,))</span>

<span class="sd">        Nullary functions are also supported::</span>

<span class="sd">            &gt;&gt;&gt; @app.task</span>
<span class="sd">            &gt;&gt;&gt; async def on_startup():</span>
<span class="sd">            ...     print(&#39;STARTING UP&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">fun</span><span class="p">:</span> <span class="n">TaskArg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskArg</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">on_leader</span><span class="o">=</span><span class="n">on_leader</span><span class="p">,</span> <span class="n">traced</span><span class="o">=</span><span class="n">traced</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_inner</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span> <span class="k">if</span> <span class="n">fun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_inner</span></div>

    <span class="k">def</span> <span class="nf">_task</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fun</span><span class="p">:</span> <span class="n">TaskArg</span><span class="p">,</span>
        <span class="n">on_leader</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">traced</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskArg</span><span class="p">:</span>
        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">_wrapped</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">should_run</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">is_leader</span><span class="p">()</span> <span class="k">if</span> <span class="n">on_leader</span> <span class="k">else</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">should_run</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">shortlabel</span><span class="p">(</span><span class="n">fun</span><span class="p">),</span> <span class="n">trace_enabled</span><span class="o">=</span><span class="n">traced</span><span class="p">):</span>
                    <span class="c1"># pass app only if decorated function takes an argument</span>
                    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                        <span class="n">task_takes_app</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Callable</span><span class="p">[[</span><span class="n">AppT</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">],</span> <span class="n">fun</span><span class="p">)</span>
                        <span class="k">return</span> <span class="k">await</span> <span class="n">task_takes_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">task</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Callable</span><span class="p">[[],</span> <span class="n">Awaitable</span><span class="p">],</span> <span class="n">fun</span><span class="p">)</span>
                        <span class="k">return</span> <span class="k">await</span> <span class="n">task</span><span class="p">()</span>

        <span class="n">venusian</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">_wrapped</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">SCAN_TASK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_wrapped</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_wrapped</span>

<div class="viewcode-block" id="App.timer"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.timer">[docs]</a>    <span class="nd">@no_type_check</span>
    <span class="k">def</span> <span class="nf">timer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="n">Seconds</span><span class="p">,</span>
        <span class="n">on_leader</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">traced</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_drift_correction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Define an async def function to be run at periodic intervals.</span>

<span class="sd">        Like :meth:`task`, but executes periodically until the worker</span>
<span class="sd">        is shut down.</span>

<span class="sd">        This decorator takes an async function and adds it to a</span>
<span class="sd">        list of timers started with the app.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            interval (Seconds): How often the timer executes in seconds.</span>

<span class="sd">            on_leader (bool) = False: Should the timer only run on the leader?</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; @app.timer(interval=10.0)</span>
<span class="sd">            &gt;&gt;&gt; async def every_10_seconds():</span>
<span class="sd">            ...     print(&#39;TEN SECONDS JUST PASSED&#39;)</span>


<span class="sd">            &gt;&gt;&gt; app.timer(interval=5.0, on_leader=True)</span>
<span class="sd">            &gt;&gt;&gt; async def every_5_seconds():</span>
<span class="sd">            ...     print(&#39;FIVE SECONDS JUST PASSED. ALSO, I AM THE LEADER!&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interval_s</span> <span class="o">=</span> <span class="n">want_seconds</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">fun</span><span class="p">:</span> <span class="n">TaskArg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskArg</span><span class="p">:</span>
            <span class="n">timer_name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">qualname</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>

            <span class="nd">@wraps</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">def</span> <span class="nf">around_timer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">async</span> <span class="k">for</span> <span class="n">sleep_time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">itertimer</span><span class="p">(</span>
                    <span class="n">interval_s</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">timer_name</span><span class="p">,</span>
                    <span class="n">max_drift_correction</span><span class="o">=</span><span class="n">max_drift_correction</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">should_run</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">on_leader</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_leader</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">should_run</span><span class="p">:</span>
                        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">shortlabel</span><span class="p">(</span><span class="n">fun</span><span class="p">),</span> <span class="n">trace_enabled</span><span class="o">=</span><span class="n">traced</span><span class="p">):</span>
                            <span class="k">await</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

            <span class="c1"># If you call @app.task without parents the return value is:</span>
            <span class="c1">#    Callable[[TaskArg], TaskArg]</span>
            <span class="c1"># but we always call @app.task() - with parens, so return value is</span>
            <span class="c1"># always TaskArg.</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">TaskArg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">around_timer</span><span class="p">,</span> <span class="n">traced</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">_inner</span></div>

<div class="viewcode-block" id="App.crontab"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.crontab">[docs]</a>    <span class="k">def</span> <span class="nf">crontab</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cron_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timezone</span><span class="p">:</span> <span class="n">tzinfo</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">on_leader</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">traced</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Define periodic task using Crontab description.</span>

<span class="sd">        This is an ``async def`` function to be run at the fixed times,</span>
<span class="sd">        defined by the Cron format.</span>

<span class="sd">        Like :meth:`timer`, but executes at fixed times instead of executing</span>
<span class="sd">        at certain intervals.</span>

<span class="sd">        This decorator takes an async function and adds it to a</span>
<span class="sd">        list of Cronjobs started with the app.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            cron_format: The Cron spec defining fixed times to run the</span>
<span class="sd">                decorated function.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            timezone: The timezone to be taken into account for the Cron jobs.</span>
<span class="sd">                If not set value from :setting:`timezone` will be taken.</span>

<span class="sd">            on_leader: Should the Cron job only run on the leader?</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; @app.crontab(cron_format=&#39;30 18 * * *&#39;,</span>
<span class="sd">                             timezone=pytz.timezone(&#39;US/Pacific&#39;))</span>
<span class="sd">            &gt;&gt;&gt; async def every_6_30_pm_pacific():</span>
<span class="sd">            ...     print(&#39;IT IS 6:30pm&#39;)</span>


<span class="sd">            &gt;&gt;&gt; app.crontab(cron_format=&#39;30 18 * * *&#39;, on_leader=True)</span>
<span class="sd">            &gt;&gt;&gt; async def every_6_30_pm():</span>
<span class="sd">            ...     print(&#39;6:30pm UTC; ALSO, I AM THE LEADER!&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">fun</span><span class="p">:</span> <span class="n">TaskArg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskArg</span><span class="p">:</span>
            <span class="nd">@wraps</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">def</span> <span class="nf">cron_starter</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_tz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">timezone</span> <span class="k">if</span> <span class="n">timezone</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">timezone</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_stop</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">cron</span><span class="o">.</span><span class="n">secs_for_next</span><span class="p">(</span><span class="n">cron_format</span><span class="p">,</span> <span class="n">_tz</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_stop</span><span class="p">:</span>
                        <span class="n">should_run</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">on_leader</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_leader</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">should_run</span><span class="p">:</span>
                            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">shortlabel</span><span class="p">(</span><span class="n">fun</span><span class="p">),</span> <span class="n">trace_enabled</span><span class="o">=</span><span class="n">traced</span><span class="p">):</span>
                                <span class="k">await</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">TaskArg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">cron_starter</span><span class="p">,</span> <span class="n">traced</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">_inner</span></div>

<div class="viewcode-block" id="App.service"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.service">[docs]</a>    <span class="k">def</span> <span class="nf">service</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">ServiceT</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Decorate :class:`mode.Service` to be started with the app.</span>

<span class="sd">        Examples:</span>
<span class="sd">            .. sourcecode:: python</span>

<span class="sd">                from mode import Service</span>

<span class="sd">                @app.service</span>
<span class="sd">                class Foo(Service):</span>
<span class="sd">                    ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">venusian</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">SCAN_SERVICE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_services</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span></div>

<div class="viewcode-block" id="App.is_leader"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.is_leader">[docs]</a>    <span class="k">def</span> <span class="nf">is_leader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return :const:`True` if we are in leader worker process.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_leader_assignor</span><span class="o">.</span><span class="n">is_leader</span><span class="p">()</span></div>

<div class="viewcode-block" id="App.stream"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.stream">[docs]</a>    <span class="k">def</span> <span class="nf">stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">channel</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">AsyncIterable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">],</span>
        <span class="n">beacon</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NodeT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StreamT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create new stream from channel/topic/iterable/async iterable.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            channel: Iterable to stream over (async or non-async).</span>

<span class="sd">            kwargs: See :class:`Stream`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            faust.Stream:</span>
<span class="sd">                to iterate over events in the stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span>
            <span class="n">StreamT</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">channel</span><span class="o">=</span><span class="n">aiter</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">beacon</span><span class="o">=</span><span class="n">beacon</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">beacon</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="App.Table"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.Table">[docs]</a>    <span class="k">def</span> <span class="nf">Table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">default</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">window</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">WindowT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">partitions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TableT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Define new table.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name: Name used for table, note that two tables living in</span>
<span class="sd">                the same application cannot have the same name.</span>

<span class="sd">            default: A callable, or type that will return a default value</span>
<span class="sd">               for keys missing in this table.</span>
<span class="sd">            window: A windowing strategy to wrap this window in.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; table = app.Table(&#39;user_to_amount&#39;, default=int)</span>
<span class="sd">            &gt;&gt;&gt; table[&#39;George&#39;]</span>
<span class="sd">            0</span>
<span class="sd">            &gt;&gt;&gt; table[&#39;Elaine&#39;] += 1</span>
<span class="sd">            &gt;&gt;&gt; table[&#39;Elaine&#39;] += 1</span>
<span class="sd">            &gt;&gt;&gt; table[&#39;Elaine&#39;]</span>
<span class="sd">            2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">cast</span><span class="p">(</span>
                <span class="n">TableT</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
                    <span class="n">beacon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">beacon</span><span class="p">,</span>
                    <span class="n">partitions</span><span class="o">=</span><span class="n">partitions</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">TableT</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">using_window</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="k">if</span> <span class="n">window</span> <span class="k">else</span> <span class="n">table</span><span class="p">)</span></div>

<div class="viewcode-block" id="App.GlobalTable"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.GlobalTable">[docs]</a>    <span class="k">def</span> <span class="nf">GlobalTable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">default</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">window</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">WindowT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">partitions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GlobalTableT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Define new global table.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name: Name used for global table, note that two global tables</span>
<span class="sd">                living in the same application cannot have the same name.</span>

<span class="sd">            default: A callable, or type that will return a default valu</span>
<span class="sd">               for keys missing in this global table.</span>
<span class="sd">            window: A windowing strategy to wrap this window in.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; gtable = app.GlobalTable(&#39;user_to_amount&#39;, default=int)</span>
<span class="sd">            &gt;&gt;&gt; gtable[&#39;George&#39;]</span>
<span class="sd">            0</span>
<span class="sd">            &gt;&gt;&gt; gtable[&#39;Elaine&#39;] += 1</span>
<span class="sd">            &gt;&gt;&gt; gtable[&#39;Elaine&#39;] += 1</span>
<span class="sd">            &gt;&gt;&gt; gtable[&#39;Elaine&#39;]</span>
<span class="sd">            2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gtable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">cast</span><span class="p">(</span>
                <span class="n">GlobalTableT</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">GlobalTable</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
                    <span class="n">beacon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">beacon</span><span class="p">,</span>
                    <span class="n">partitions</span><span class="o">=</span><span class="n">partitions</span><span class="p">,</span>
                    <span class="c1"># we want to apply standby changes</span>
                    <span class="c1"># as they come min (using 1 buffer size).</span>
                    <span class="n">standby_buffer_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">is_global</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">GlobalTableT</span><span class="p">,</span> <span class="n">gtable</span><span class="o">.</span><span class="n">using_window</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="k">if</span> <span class="n">window</span> <span class="k">else</span> <span class="n">gtable</span><span class="p">)</span></div>

<div class="viewcode-block" id="App.SetTable"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.SetTable">[docs]</a>    <span class="k">def</span> <span class="nf">SetTable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">window</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">WindowT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">partitions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_manager</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TableT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Table of sets.&quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">cast</span><span class="p">(</span>
                <span class="n">TableT</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">SetTable</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">beacon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">beacon</span><span class="p">,</span>
                    <span class="n">partitions</span><span class="o">=</span><span class="n">partitions</span><span class="p">,</span>
                    <span class="n">start_manager</span><span class="o">=</span><span class="n">start_manager</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">TableT</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">using_window</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="k">if</span> <span class="n">window</span> <span class="k">else</span> <span class="n">table</span><span class="p">)</span></div>

<div class="viewcode-block" id="App.SetGlobalTable"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.SetGlobalTable">[docs]</a>    <span class="k">def</span> <span class="nf">SetGlobalTable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">window</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">WindowT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">partitions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_manager</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TableT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Table of sets (global).&quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">cast</span><span class="p">(</span>
                <span class="n">TableT</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">SetGlobalTable</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">beacon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">beacon</span><span class="p">,</span>
                    <span class="n">partitions</span><span class="o">=</span><span class="n">partitions</span><span class="p">,</span>
                    <span class="n">start_manager</span><span class="o">=</span><span class="n">start_manager</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">TableT</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">using_window</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="k">if</span> <span class="n">window</span> <span class="k">else</span> <span class="n">table</span><span class="p">)</span></div>

<div class="viewcode-block" id="App.page"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.page">[docs]</a>    <span class="k">def</span> <span class="nf">page</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">base</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">View</span><span class="p">]</span> <span class="o">=</span> <span class="n">View</span><span class="p">,</span>
        <span class="n">cors_options</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ResourceOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">PageArg</span><span class="p">],</span> <span class="n">Type</span><span class="p">[</span><span class="n">View</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Decorate view to be included in the web server.&quot;&quot;&quot;</span>
        <span class="n">view_base</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">View</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span> <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">View</span>

        <span class="k">def</span> <span class="nf">_decorator</span><span class="p">(</span><span class="n">fun</span><span class="p">:</span> <span class="n">PageArg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">View</span><span class="p">]:</span>
            <span class="n">view</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">View</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
                <span class="n">view</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Type</span><span class="p">[</span><span class="n">View</span><span class="p">],</span> <span class="n">fun</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;When decorating class, it must be subclass of View&quot;</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="n">view</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">view</span> <span class="o">=</span> <span class="n">view_base</span><span class="o">.</span><span class="n">from_handler</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">ViewHandlerFun</span><span class="p">,</span> <span class="n">fun</span><span class="p">))</span>
            <span class="n">view</span><span class="o">.</span><span class="n">view_name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">view</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">view</span><span class="o">.</span><span class="n">view_path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">cors_options</span><span class="o">=</span><span class="n">cors_options</span><span class="p">)</span>
            <span class="n">venusian</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">SCAN_PAGE</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">view</span>

        <span class="k">return</span> <span class="n">_decorator</span></div>

<div class="viewcode-block" id="App.table_route"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.table_route">[docs]</a>    <span class="k">def</span> <span class="nf">table_route</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table</span><span class="p">:</span> <span class="n">CollectionT</span><span class="p">,</span>
        <span class="n">shard_param</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">query_param</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">match_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exact_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ViewDecorator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Decorate view method to route request to table key destination.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_decorator</span><span class="p">(</span><span class="n">fun</span><span class="p">:</span> <span class="n">ViewHandlerFun</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ViewHandlerFun</span><span class="p">:</span>
            <span class="n">_query_param</span> <span class="o">=</span> <span class="n">query_param</span>
            <span class="k">if</span> <span class="n">shard_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">(</span><span class="n">W_DEPRECATED_SHARD_PARAM</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">query_param</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot specify shard_param and query_param&quot;</span><span class="p">)</span>
                <span class="n">_query_param</span> <span class="o">=</span> <span class="n">shard_param</span>
            <span class="k">if</span> <span class="n">_query_param</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">match_info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">exact_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Need one of query_param, shard_param, or exact key&quot;</span><span class="p">)</span>

            <span class="nd">@wraps</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span>
                <span class="n">view</span><span class="p">:</span> <span class="n">View</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exact_key</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">exact_key</span>
                <span class="k">elif</span> <span class="n">match_info</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">match_info</span><span class="p">[</span><span class="n">match_info</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">_query_param</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="p">[</span><span class="n">_query_param</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;cannot get here&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">route_req</span><span class="p">(</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">view</span><span class="o">.</span><span class="n">web</span><span class="p">,</span> <span class="n">request</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">SameNode</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">fun</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

            <span class="k">return</span> <span class="n">get</span>

        <span class="k">return</span> <span class="n">_decorator</span></div>

<div class="viewcode-block" id="App.topic_route"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.topic_route">[docs]</a>    <span class="k">def</span> <span class="nf">topic_route</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">topic</span><span class="p">:</span> <span class="n">CollectionT</span><span class="p">,</span>
        <span class="n">shard_param</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">query_param</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">match_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exact_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ViewDecorator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Decorate view method to route request to a topic partition destination.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_decorator</span><span class="p">(</span><span class="n">fun</span><span class="p">:</span> <span class="n">ViewHandlerFun</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ViewHandlerFun</span><span class="p">:</span>
            <span class="n">_query_param</span> <span class="o">=</span> <span class="n">query_param</span>
            <span class="k">if</span> <span class="n">shard_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">(</span><span class="n">W_DEPRECATED_SHARD_PARAM</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">query_param</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot specify shard_param and query_param&quot;</span><span class="p">)</span>
                <span class="n">_query_param</span> <span class="o">=</span> <span class="n">shard_param</span>
            <span class="k">if</span> <span class="n">_query_param</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">match_info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">exact_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Need one of query_param, shard_param, or exact key&quot;</span><span class="p">)</span>

            <span class="nd">@wraps</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span>
                <span class="n">view</span><span class="p">:</span> <span class="n">View</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exact_key</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">exact_key</span>
                <span class="k">elif</span> <span class="n">match_info</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">match_info</span><span class="p">[</span><span class="n">match_info</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">_query_param</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="p">[</span><span class="n">_query_param</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;cannot get here&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">route_topic_req</span><span class="p">(</span>
                        <span class="n">topic</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">view</span><span class="o">.</span><span class="n">web</span><span class="p">,</span> <span class="n">request</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">SameNode</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">fun</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

            <span class="k">return</span> <span class="n">get</span>

        <span class="k">return</span> <span class="n">_decorator</span></div>

<div class="viewcode-block" id="App.command"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.command">[docs]</a>    <span class="k">def</span> <span class="nf">command</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">options</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">_AppCommand</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Callable</span><span class="p">],</span> <span class="n">Type</span><span class="p">[</span><span class="n">_AppCommand</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Decorate ``async def`` function to be used as CLI command.&quot;&quot;&quot;</span>
        <span class="n">_base</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_AppCommand</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">faust.cli</span> <span class="k">import</span> <span class="n">base</span> <span class="k">as</span> <span class="n">cli_base</span>

            <span class="n">_base</span> <span class="o">=</span> <span class="n">cli_base</span><span class="o">.</span><span class="n">AppCommand</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_base</span> <span class="o">=</span> <span class="n">base</span>

        <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">fun</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_AppCommand</span><span class="p">]:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">_base</span><span class="o">.</span><span class="n">from_handler</span><span class="p">(</span><span class="o">*</span><span class="n">options</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)(</span><span class="n">fun</span><span class="p">)</span>
            <span class="n">venusian</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">SCAN_COMMAND</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cmd</span>

        <span class="k">return</span> <span class="n">_inner</span></div>

<div class="viewcode-block" id="App.create_event"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.create_event">[docs]</a>    <span class="k">def</span> <span class="nf">create_event</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">K</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">V</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">HeadersArg</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EventT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create new :class:`faust.Event` object.&quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">EventT</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span></div>

<div class="viewcode-block" id="App.start_client"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.start_client">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">start_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Start the app in Client-Only mode necessary for RPC requests.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Once started as a client the app cannot be restarted as Server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_only</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">stop_flow</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">topics</span><span class="o">.</span><span class="n">maybe_wait_for_subscriptions</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">topics</span><span class="o">.</span><span class="n">on_client_only_start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">resume_flow</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow_control</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span></div>

<div class="viewcode-block" id="App.maybe_start_client"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.maybe_start_client">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">maybe_start_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Start the app in Client-Only mode if not started as Server.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_client</span><span class="p">()</span></div>

<div class="viewcode-block" id="App.trace"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.trace">[docs]</a>    <span class="k">def</span> <span class="nf">trace</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">trace_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_context</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ContextManager</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return new trace context to trace operation using OpenTracing.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">trace_enabled</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nullcontext</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_context</span><span class="p">)</span></div>

<div class="viewcode-block" id="App.traced"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.traced">[docs]</a>    <span class="k">def</span> <span class="nf">traced</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fun</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">context</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Decorate function to be traced using the OpenTracing API.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">fun</span>
        <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">operation_name_from_fun</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
            <span class="n">span</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span> <span class="o">**</span><span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">call_with_trace</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapped</span></div>

    <span class="k">def</span> <span class="nf">_start_span_from_rebalancing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">opentracing</span><span class="o">.</span><span class="n">Span</span><span class="p">:</span>
        <span class="n">rebalancing_span</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rebalancing_span</span>
        <span class="k">if</span> <span class="n">rebalancing_span</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">category</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.conf.name}</span><span class="s2">-_faust&quot;</span>
            <span class="n">span</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">get_tracer</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span>
                <span class="n">operation_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">child_of</span><span class="o">=</span><span class="n">rebalancing_span</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_span_add_default_tags</span><span class="p">(</span><span class="n">span</span><span class="p">)</span>
            <span class="n">set_current_span</span><span class="p">(</span><span class="n">span</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">span</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">noop_span</span><span class="p">()</span>

<div class="viewcode-block" id="App.send"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.send">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">channel</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ChannelT</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">K</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">V</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">partition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timestamp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">HeadersArg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SchemaT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">key_serializer</span><span class="p">:</span> <span class="n">CodecArg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">value_serializer</span><span class="p">:</span> <span class="n">CodecArg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MessageSentCallback</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">RecordMetadata</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Send event to channel/topic.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            channel: Channel/topic or the name of a topic to send event to.</span>
<span class="sd">            key: Message key.</span>
<span class="sd">            value: Message value.</span>
<span class="sd">            partition: Specific partition to send to.</span>
<span class="sd">                If not set the partition will be chosen by the partitioner.</span>
<span class="sd">            timestamp: Epoch seconds (from Jan 1 1970</span>
<span class="sd">                UTC) to use as the message timestamp. Defaults to current time.</span>
<span class="sd">            headers: Mapping of key/value pairs, or iterable of key value</span>
<span class="sd">                pairs to use as headers for the message.</span>
<span class="sd">            schema: :class:`~faust.Schema` to use for serialization.</span>
<span class="sd">            key_serializer: Serializer to use (if value is not model).</span>
<span class="sd">                Overrides schema if one is specified.</span>
<span class="sd">            value_serializer: Serializer to use (if value is not model).</span>
<span class="sd">                Overrides schema if one is specified.</span>
<span class="sd">            callback: Called after the message is fully delivered to the</span>
<span class="sd">                channel, but not to the consumer.</span>
<span class="sd">                Signature must be unary as the</span>
<span class="sd">                :class:`~faust.types.tuples.FutureMessage` future is passed</span>
<span class="sd">                to it.</span>

<span class="sd">                The resulting :class:`faust.types.tuples.RecordMetadata`</span>
<span class="sd">                object is then available as ``fut.result()``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chan</span><span class="p">:</span> <span class="n">ChannelT</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chan</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">chan</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
            <span class="n">partition</span><span class="o">=</span><span class="n">partition</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">key_serializer</span><span class="o">=</span><span class="n">key_serializer</span><span class="p">,</span>
            <span class="n">value_serializer</span><span class="o">=</span><span class="n">value_serializer</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="App.in_transaction"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.in_transaction">[docs]</a>    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">in_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return :const:`True` if stream is using transactions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_worker</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">processing_guarantee</span> <span class="o">==</span> <span class="n">ProcessingGuarantee</span><span class="o">.</span><span class="n">EXACTLY_ONCE</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="App.LiveCheck"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.LiveCheck">[docs]</a>    <span class="k">def</span> <span class="nf">LiveCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_LiveCheck</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return new LiveCheck instance testing features for this app.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">faust.livecheck</span> <span class="k">import</span> <span class="n">LiveCheck</span>

        <span class="k">return</span> <span class="n">LiveCheck</span><span class="o">.</span><span class="n">for_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="App.maybe_start_producer"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.maybe_start_producer">[docs]</a>    <span class="nd">@stampede</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">maybe_start_producer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProducerT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Ensure producer is started.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">:</span>
            <span class="c1"># return TransactionManager when</span>
            <span class="c1"># processing_guarantee=&quot;exactly_once&quot; enabled.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">transactions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">producer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">producer</span>
            <span class="c1"># producer may also have been started by app.start()</span>
            <span class="k">await</span> <span class="n">producer</span><span class="o">.</span><span class="n">maybe_start</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">producer</span></div>

<div class="viewcode-block" id="App.commit"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.commit">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topics</span><span class="p">:</span> <span class="n">TPorTopicSet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Commit offset for acked messages in specified topics&#39;.</span>

<span class="sd">        Warning:</span>
<span class="sd">            This will commit acked messages in **all topics**</span>
<span class="sd">            if the topics argument is passed in as :const:`None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">topics</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span></div>

<div class="viewcode-block" id="App.on_stop"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.on_stop">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Call when application stops.</span>

<span class="sd">        Tip:</span>
<span class="sd">            Remember to call ``super`` if you override this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_consumer</span><span class="p">()</span>
        <span class="c1"># send shutdown signal</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_before_shutdown</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_producer_flush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_close_http_client</span><span class="p">()</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_producer_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_producer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Flush producer buffer...&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_producer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_stop_consumer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consumer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">consumer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consumer</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">assignment</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="n">assignment</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">ConsumerNotStarted</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">assignment</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">on_partitions_revoked</span><span class="p">(</span><span class="n">assignment</span><span class="p">)</span>
                    <span class="n">consumer</span><span class="o">.</span><span class="n">stop_flow</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">flow_control</span><span class="o">.</span><span class="n">suspend</span><span class="p">()</span>
                    <span class="n">consumer</span><span class="o">.</span><span class="n">pause_partitions</span><span class="p">(</span><span class="n">assignment</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">flow_control</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_fetcher</span><span class="p">()</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consumer_wait_empty</span><span class="p">(</span><span class="n">consumer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_consumer_wait_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">consumer</span><span class="p">:</span> <span class="n">ConsumerT</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">stream_wait_empty</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Wait for streams...&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">consumer</span><span class="o">.</span><span class="n">wait_empty</span><span class="p">()</span>

<div class="viewcode-block" id="App.on_rebalance_start"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.on_rebalance_start">[docs]</a>    <span class="k">def</span> <span class="nf">on_rebalance_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Call when rebalancing starts.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rebalancing</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rebalancing_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rebalancing_sensor_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sensors</span><span class="o">.</span><span class="n">on_rebalance_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracer</span><span class="p">:</span>
            <span class="n">category</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.conf.name}</span><span class="s2">-_faust&quot;</span>
            <span class="n">tracer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">get_tracer</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rebalancing_span</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span>
                <span class="n">operation_name</span><span class="o">=</span><span class="s2">&quot;rebalance&quot;</span><span class="p">,</span>
                <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rebalancing_count&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rebalancing_count</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">on_rebalance_start</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_span_add_default_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">:</span> <span class="n">opentracing</span><span class="o">.</span><span class="n">Span</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">span</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s2">&quot;faust_app&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">span</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s2">&quot;faust_id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<div class="viewcode-block" id="App.on_rebalance_return"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.on_rebalance_return">[docs]</a>    <span class="k">def</span> <span class="nf">on_rebalance_return</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sensor_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rebalancing_sensor_state</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sensor_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Missing sensor state for rebalance #</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rebalancing_count</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sensors</span><span class="o">.</span><span class="n">on_rebalance_return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sensor_state</span><span class="p">)</span></div>

<div class="viewcode-block" id="App.on_rebalance_end"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.on_rebalance_end">[docs]</a>    <span class="k">def</span> <span class="nf">on_rebalance_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Call when rebalancing is done.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rebalancing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rebalancing_span</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rebalancing_span</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rebalancing_span</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sensor_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rebalancing_sensor_state</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sensor_state</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Missing sensor state for rebalance end #</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rebalancing_count</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sensors</span><span class="o">.</span><span class="n">on_rebalance_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sensor_state</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rebalancing_sensor_state</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_on_partitions_revoked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">revoked</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">TP</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Handle revocation of topic partitions.</span>

<span class="sd">        This is called during a rebalance and is followed by</span>
<span class="sd">        :meth:`on_partitions_assigned`.</span>

<span class="sd">        Revoked means the partitions no longer exist, or they</span>
<span class="sd">        have been reassigned to a different node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_stop</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_rebalance_when_stopped</span><span class="p">()</span>
        <span class="n">session_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">broker_session_timeout</span> <span class="o">*</span> <span class="mf">0.95</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">traced_from_parent_span</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">flight_recorder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">session_timeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">on_timeout</span><span class="p">:</span>
            <span class="n">consumer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">dev</span><span class="p">(</span><span class="s2">&quot;ON PARTITIONS REVOKED&quot;</span><span class="p">)</span>
                <span class="n">T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">on_partitions_revoked</span><span class="p">)(</span><span class="n">revoked</span><span class="p">)</span>
                <span class="n">assignment</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="n">assignment</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">assignment</span><span class="p">:</span>
                    <span class="n">on_timeout</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;flow_control.suspend()&quot;</span><span class="p">)</span>
                    <span class="n">T</span><span class="p">(</span><span class="n">consumer</span><span class="o">.</span><span class="n">stop_flow</span><span class="p">)()</span>
                    <span class="n">T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow_control</span><span class="o">.</span><span class="n">suspend</span><span class="p">)()</span>
                    <span class="n">on_timeout</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;consumer.pause_partitions&quot;</span><span class="p">)</span>
                    <span class="n">T</span><span class="p">(</span><span class="n">consumer</span><span class="o">.</span><span class="n">pause_partitions</span><span class="p">)(</span><span class="n">assignment</span><span class="p">)</span>

                    <span class="c1"># Every agent instance has an incoming buffer of messages</span>
                    <span class="c1"># (a asyncio.Queue) -- we clear those to make sure</span>
                    <span class="c1"># agents will not start processing them.</span>
                    <span class="c1">#</span>
                    <span class="c1"># This allows for large buffer sizes</span>
                    <span class="c1"># (stream_buffer_maxsize).</span>
                    <span class="n">on_timeout</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;flow_control.clear()&quot;</span><span class="p">)</span>
                    <span class="n">T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow_control</span><span class="o">.</span><span class="n">clear</span><span class="p">)()</span>

                    <span class="c1"># even if we clear, some of the agent instances may have</span>
                    <span class="c1"># already started working on an event.</span>
                    <span class="c1">#</span>
                    <span class="c1"># we need to wait for them.</span>
                    <span class="k">await</span> <span class="n">T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_consumer_wait_empty</span><span class="p">)(</span><span class="n">consumer</span><span class="p">,</span> <span class="n">on_timeout</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_producer_flush</span><span class="p">)(</span><span class="n">on_timeout</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">T</span><span class="p">(</span><span class="n">consumer</span><span class="o">.</span><span class="n">transactions</span><span class="o">.</span><span class="n">on_partitions_revoked</span><span class="p">)(</span><span class="n">revoked</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">dev</span><span class="p">(</span><span class="s2">&quot;ON P. REVOKED NOT COMMITTING: NO ASSIGNMENT&quot;</span><span class="p">)</span>
                <span class="n">on_timeout</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;+send signal: on_partitions_revoked&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_partitions_revoked</span><span class="o">.</span><span class="n">send</span><span class="p">)(</span><span class="n">revoked</span><span class="p">)</span>
                <span class="n">on_timeout</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-send signal: on_partitions_revoked&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">on_timeout</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;on partitions revoked crashed: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">crash</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_stop_fetcher</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetcher</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="c1"># Reset fetcher service state so that we can restart it</span>
        <span class="c1"># in TableManager table recovery.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fetcher</span><span class="o">.</span><span class="n">service_reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_on_rebalance_when_stopped</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_on_partitions_assigned</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">assigned</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">TP</span><span class="p">],</span> <span class="n">generation_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Handle new topic partition assignment.</span>

<span class="sd">        This is called during a rebalance after :meth:`on_partitions_revoked`.</span>

<span class="sd">        The new assignment overrides the previous</span>
<span class="sd">        assignment, so any tp no longer in the assigned&#39; list will have</span>
<span class="sd">        been revoked.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_stop</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_rebalance_when_stopped</span><span class="p">()</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">traced_from_parent_span</span><span class="p">()</span>
        <span class="c1"># shave some time off so we timeout before the broker</span>
        <span class="c1"># (Kafka does not send error, it just logs)</span>
        <span class="n">session_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">broker_session_timeout</span> <span class="o">*</span> <span class="mf">0.95</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unassigned</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">assigned</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing _on_partitions_assigned&quot;</span><span class="p">)</span>
        <span class="n">revoked</span><span class="p">,</span> <span class="n">newly_assigned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_assignment</span><span class="p">(</span><span class="n">assigned</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">flight_recorder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">session_timeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">on_timeout</span><span class="p">:</span>
            <span class="n">consumer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">on_timeout</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;agents.on_rebalance()&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">T</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">on_rebalance</span><span class="p">,</span>
                    <span class="n">revoked</span><span class="o">=</span><span class="n">revoked</span><span class="p">,</span>
                    <span class="n">newly_assigned</span><span class="o">=</span><span class="n">newly_assigned</span><span class="p">,</span>
                <span class="p">)(</span><span class="n">revoked</span><span class="p">,</span> <span class="n">newly_assigned</span><span class="p">)</span>
                <span class="c1"># Wait for transport.Conductor to finish</span>
                <span class="c1"># calling Consumer.subscribe</span>
                <span class="n">on_timeout</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;topics.wait_for_subscriptions()&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topics</span><span class="o">.</span><span class="n">maybe_wait_for_subscriptions</span><span class="p">)()</span>
                <span class="n">on_timeout</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;consumer.pause_partitions()&quot;</span><span class="p">)</span>
                <span class="n">T</span><span class="p">(</span><span class="n">consumer</span><span class="o">.</span><span class="n">pause_partitions</span><span class="p">)(</span><span class="n">assigned</span><span class="p">)</span>
                <span class="n">on_timeout</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;topics.on_partitions_assigned()&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topics</span><span class="o">.</span><span class="n">on_partitions_assigned</span><span class="p">)(</span><span class="n">assigned</span><span class="p">)</span>
                <span class="n">on_timeout</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;transactions.on_rebalance()&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">T</span><span class="p">(</span><span class="n">consumer</span><span class="o">.</span><span class="n">transactions</span><span class="o">.</span><span class="n">on_rebalance</span><span class="p">)(</span>
                        <span class="n">assigned</span><span class="p">,</span> <span class="n">revoked</span><span class="p">,</span> <span class="n">newly_assigned</span>
                    <span class="p">)</span>
                <span class="n">on_timeout</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;tables.on_rebalance()&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">on_rebalance</span><span class="p">)(</span>
                    <span class="n">assigned</span><span class="p">,</span> <span class="n">revoked</span><span class="p">,</span> <span class="n">newly_assigned</span><span class="p">,</span> <span class="n">generation_id</span>
                <span class="p">)</span>
                <span class="n">on_timeout</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;+send signal: on_partitions_assigned&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_partitions_assigned</span><span class="o">.</span><span class="n">send</span><span class="p">)(</span><span class="n">assigned</span><span class="p">)</span>
                <span class="n">on_timeout</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-send signal: on_partitions_assigned&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">on_timeout</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;on partitions assigned crashed: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">crash</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assigned</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">TP</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="n">TP</span><span class="p">],</span> <span class="n">Set</span><span class="p">[</span><span class="n">TP</span><span class="p">]]:</span>
        <span class="n">revoked</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">TP</span><span class="p">]</span>
        <span class="n">newly_assigned</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">TP</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assignment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">revoked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assignment</span> <span class="o">-</span> <span class="n">assigned</span>
            <span class="n">newly_assigned</span> <span class="o">=</span> <span class="n">assigned</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assignment</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">revoked</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">newly_assigned</span> <span class="o">=</span> <span class="n">assigned</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assignment</span> <span class="o">=</span> <span class="n">assigned</span>
        <span class="k">return</span> <span class="n">revoked</span><span class="p">,</span> <span class="n">newly_assigned</span>

    <span class="k">def</span> <span class="nf">_new_producer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProducerT</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">create_producer</span><span class="p">(</span><span class="n">beacon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beacon</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_new_consumer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConsumerT</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">create_consumer</span><span class="p">(</span>
            <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">topics</span><span class="o">.</span><span class="n">on_message</span><span class="p">,</span>
            <span class="n">on_partitions_revoked</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_partitions_revoked</span><span class="p">,</span>
            <span class="n">on_partitions_assigned</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_partitions_assigned</span><span class="p">,</span>
            <span class="n">beacon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beacon</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_new_conductor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConductorT</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">create_conductor</span><span class="p">(</span><span class="n">beacon</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_new_transport</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransportT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">transport</span><span class="o">.</span><span class="n">by_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">broker_consumer</span><span class="p">[</span><span class="mi">0</span><span class="p">])(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">broker_consumer</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_new_producer_transport</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransportT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">transport</span><span class="o">.</span><span class="n">by_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">broker_producer</span><span class="p">[</span><span class="mi">0</span><span class="p">])(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">broker_producer</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_new_cache_backend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CacheBackendT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cache_backends</span><span class="o">.</span><span class="n">by_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">cache</span><span class="p">)(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">cache</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span>
        <span class="p">)</span>

<div class="viewcode-block" id="App.FlowControlQueue"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.FlowControlQueue">[docs]</a>    <span class="k">def</span> <span class="nf">FlowControlQueue</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">maxsize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">clear_on_resume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ThrowableQueue</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Like :class:`asyncio.Queue`, but can be suspended/resumed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ThrowableQueue</span><span class="p">(</span>
            <span class="n">maxsize</span><span class="o">=</span><span class="n">maxsize</span><span class="p">,</span>
            <span class="n">flow_control</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flow_control</span><span class="p">,</span>
            <span class="n">clear_on_resume</span><span class="o">=</span><span class="n">clear_on_resume</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="App.Worker"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.Worker">[docs]</a>    <span class="k">def</span> <span class="nf">Worker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Worker</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return application worker instance.&quot;&quot;&quot;</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">Worker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">_Worker</span><span class="p">,</span> <span class="n">worker</span><span class="p">)</span></div>

<div class="viewcode-block" id="App.on_webserver_init"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.on_webserver_init">[docs]</a>    <span class="k">def</span> <span class="nf">on_webserver_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">web</span><span class="p">:</span> <span class="n">Web</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Call when the Web server is initializing.&quot;&quot;&quot;</span>
        <span class="o">...</span></div>

    <span class="k">def</span> <span class="nf">_create_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">datadir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">appdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">tabledir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">APP_REPR_FINALIZED</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span>
                <span class="n">agents</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">,</span>
                <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">APP_REPR_UNFINALIZED</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_before_configured</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_settings</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_configured</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configured</span> <span class="o">=</span> <span class="n">conf</span><span class="p">,</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_after_configured</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_load_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Settings</span><span class="p">:</span>
        <span class="n">changes</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">appid</span><span class="p">,</span> <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_options</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_source</span><span class="p">:</span>
            <span class="n">changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_settings_from_source</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_config_source</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span>
            <span class="p">)</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Settings</span><span class="p">(</span><span class="n">appid</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_prepare_compat_settings</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_prepare_compat_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
        <span class="n">COMPAT_OPTIONS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="s2">&quot;broker_client_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;commit_interval&quot;</span><span class="p">:</span> <span class="s2">&quot;broker_commit_interval&quot;</span><span class="p">,</span>
            <span class="s2">&quot;create_reply_topic&quot;</span><span class="p">:</span> <span class="s2">&quot;reply_create_topic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;num_standby_replicas&quot;</span><span class="p">:</span> <span class="s2">&quot;table_standby_replicas&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default_partitions&quot;</span><span class="p">:</span> <span class="s2">&quot;topic_partitions&quot;</span><span class="p">,</span>
            <span class="s2">&quot;replication_factor&quot;</span><span class="p">:</span> <span class="s2">&quot;topic_replication_factor&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">COMPAT_OPTIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">options</span><span class="p">[</span><span class="n">new</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">old</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span>
                        <span class="n">f</span><span class="s2">&quot;Cannot use both compat option </span><span class="si">{old!r}</span><span class="s2"> and </span><span class="si">{new!r}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="ne">FutureWarning</span><span class="p">(</span><span class="n">W_OPTION_DEPRECATED</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">new</span><span class="p">))</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">options</span>

    <span class="k">def</span> <span class="nf">_load_settings_from_source</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">smart_import</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">imp</span><span class="o">=</span><span class="n">import_from_cwd</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">return</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">force_mapping</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">conf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Settings</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Application configuration.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalized</span> <span class="ow">and</span> <span class="n">STRICT</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span>
                <span class="s2">&quot;App configuration accessed before app.finalize()&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">_Settings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">)</span>

    <span class="nd">@conf</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">_Settings</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span> <span class="o">=</span> <span class="n">settings</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">producer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProducerT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Message producer.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_producer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_producer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_producer</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_producer</span>

    <span class="nd">@producer</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">producer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">producer</span><span class="p">:</span> <span class="n">ProducerT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_producer</span> <span class="o">=</span> <span class="n">producer</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">consumer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConsumerT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Message consumer.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consumer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_consumer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_consumer</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consumer</span>

    <span class="nd">@consumer</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">consumer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">consumer</span><span class="p">:</span> <span class="n">ConsumerT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consumer</span> <span class="o">=</span> <span class="n">consumer</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">transport</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransportT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Consumer message transport.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_transport</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span>

    <span class="nd">@transport</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">transport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transport</span><span class="p">:</span> <span class="n">TransportT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span> <span class="o">=</span> <span class="n">transport</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">producer_transport</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransportT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Producer message transport.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_producer_transport</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_producer_transport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_producer_transport</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_producer_transport</span>

    <span class="nd">@producer_transport</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">producer_transport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transport</span><span class="p">:</span> <span class="n">TransportT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_producer_transport</span> <span class="o">=</span> <span class="n">transport</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CacheBackendT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cache backend.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_cache_backend</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>

    <span class="nd">@cache</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n">CacheBackendT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">cache</span>

<div class="viewcode-block" id="App.tables"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.tables">[docs]</a>    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TableManagerT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Map of available tables, and the table manager service.&quot;&quot;&quot;</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">TableManager</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">,</span>
            <span class="n">beacon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beacon</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">TableManagerT</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span></div>

<div class="viewcode-block" id="App.topics"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.topics">[docs]</a>    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">topics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConductorT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Topic Conductor.</span>

<span class="sd">        This is the mediator that moves messages fetched by the Consumer</span>
<span class="sd">        into the streams.</span>

<span class="sd">        It&#39;s also a set of registered topics by string topic name, so you</span>
<span class="sd">        can check if a topic is being consumed from by doing</span>
<span class="sd">        ``topic in app.topics``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_conductor</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Monitor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Monitor keeps stats about what&#39;s going on inside the worker.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
                <span class="n">Monitor</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">Monitor</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">,</span> <span class="n">beacon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beacon</span><span class="p">),</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span>

    <span class="nd">@monitor</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitor</span><span class="p">:</span> <span class="n">Monitor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span> <span class="o">=</span> <span class="n">monitor</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_fetcher</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Fetcher</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetcher helps Kafka Consumer retrieve records in topics.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Type</span><span class="p">[</span><span class="n">_Fetcher</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">Fetcher</span><span class="p">)(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">,</span> <span class="n">beacon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">beacon</span>
        <span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_reply_consumer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReplyConsumer</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Kafka Consumer that consumes agent replies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ReplyConsumer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">,</span> <span class="n">beacon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beacon</span><span class="p">)</span>

<div class="viewcode-block" id="App.flow_control"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.flow_control">[docs]</a>    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">flow_control</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlowControlEvent</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Flow control of streams.</span>

<span class="sd">        This object controls flow into stream queues,</span>
<span class="sd">        and can also clear all buffers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">FlowControlEvent</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">http_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpClientT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;HTTP client Session.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">HttpClient</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_http_client</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">HttpClientT</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http_client</span>

    <span class="nd">@http_client</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">http_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">HttpClientT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_http_client</span> <span class="o">=</span> <span class="n">client</span>

<div class="viewcode-block" id="App.assignor"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.assignor">[docs]</a>    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">assignor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PartitionAssignorT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Partition Assignor.</span>

<span class="sd">        Responsible for partition assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assignor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">PartitionAssignor</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">replicas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">table_standby_replicas</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">PartitionAssignorT</span><span class="p">,</span> <span class="n">assignor</span><span class="p">)</span></div>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_leader_assignor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LeaderAssignorT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Leader assignor.</span>

<span class="sd">        The leader assignor is a special Kafka partition assignor,</span>
<span class="sd">        used to find the leader in a cluster of Faust worker nodes,</span>
<span class="sd">        and enables the ``@app.timer(on_leader=True)`` feature that executes</span>
<span class="sd">        exclusively on one node at a time. Excellent for things that would</span>
<span class="sd">        traditionally require a lock/mutex.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assignor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">LeaderAssignor</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">,</span> <span class="n">beacon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beacon</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">LeaderAssignorT</span><span class="p">,</span> <span class="n">assignor</span><span class="p">)</span>

<div class="viewcode-block" id="App.router"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.router">[docs]</a>    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RouterT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find the node partitioned data belongs to.</span>

<span class="sd">        The router helps us route web requests to the wanted Faust node.</span>
<span class="sd">        If a topic is sharded by account_id, the router can send us to the</span>
<span class="sd">        Faust worker responsible for any account.  Used by the</span>
<span class="sd">        ``@app.table_route`` decorator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">router</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">Router</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">RouterT</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span></div>

<div class="viewcode-block" id="App.web"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.web">[docs]</a>    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">web</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Web</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Web driver.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_web</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_new_web</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Web</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">web_drivers</span><span class="o">.</span><span class="n">by_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">web</span><span class="p">)(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="App.serializers"><a class="viewcode-back" href="../../../reference/faust.app.base.html#faust.App.serializers">[docs]</a>    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">serializers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RegistryT</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return serializer registry.&quot;&quot;&quot;</span>
        <span class="c1"># Many things such as key_serializer/value_serializer configures</span>
        <span class="c1"># the serializer by name (e.g. &quot;json&quot;). The serializer registry</span>
        <span class="c1"># lets you extend Faust with support for additional</span>
        <span class="c1"># serialization formats.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>  <span class="c1"># easiest way to autofinalize for topic.send</span>
        <span class="n">serializers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">Serializers</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">key_serializer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">key_serializer</span><span class="p">,</span>
            <span class="n">value_serializer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">value_serializer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">RegistryT</span><span class="p">,</span> <span class="n">serializers</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return human readable description of application.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.shortlabel}</span><span class="s2">: </span><span class="si">{self.conf.id}</span><span class="s2">@</span><span class="si">{self.conf.broker}</span><span class="s2">&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shortlabel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return short description of application.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../../index.html">Faust</a></h1>



<p class="blurb">A library for building streaming applications in Python.</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=robinhood&repo=faust&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/robinhood/faust">
    <img
        alt="https://secure.travis-ci.org/robinhood/faust.svg?branch=master"
        src="https://secure.travis-ci.org/robinhood/faust.svg?branch=master"
    />
</a>
</p>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Copyright</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Introducing Faust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../playbooks/index.html">Playbooks</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide/index.html">User Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">Frequently Asked Questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developerguide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../history/index.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017-2020, 2021-2022 Community, Robinhood Markets, Inc..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/robinhood/faust" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>